#!/bin/bash
# deploy.sh - Auto deploy FlowServiceBackend

# ------------------------
# Configuration
# ------------------------
REPO_DIR="/home/backend/FlowServiceBackend"   # Git repo folder
PUBLISH_DIR="/home/backend/publish"          # Dotnet publish output
SERVICE_NAME="backend"                        # systemd service name
BRANCH="main"                                 # Git branch to track
ENV_FILE="/home/backend/.env"                 # Optional environment file

# ------------------------
# Load environment variables
# ------------------------
if [ -f "$ENV_FILE" ]; then
    export $(grep -v '^#' $ENV_FILE | xargs)
fi

# ------------------------
# Go to repo folder
# ------------------------
cd $REPO_DIR || { echo "‚ùå Cannot enter $REPO_DIR"; exit 1; }

# ------------------------
# Ensure correct branch
# ------------------------
git checkout $BRANCH

# ------------------------
# Fetch latest commits
# ------------------------
git fetch origin $BRANCH

# ------------------------
# Compare local HEAD with remote
# ------------------------
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/$BRANCH)

if [ "$LOCAL" != "$REMOTE" ]; then
    echo "üöÄ New changes detected. Deploying..."

    # Pull latest code and reset
    git reset --hard origin/$BRANCH

    # Restore dependencies
    dotnet restore

    # Publish production build
    dotnet publish -c Release -o $PUBLISH_DIR

    # Restart the backend service
    sudo systemctl restart $SERVICE_NAME

    echo "‚úÖ Deployment finished successfully."
else
    echo "‚ÑπÔ∏è No changes detected."
fi
